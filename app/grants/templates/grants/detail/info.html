{% comment %}
  Copyright (C) 2020 Gitcoin Core

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published
  by the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program. If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% load static humanize i18n grants_extra %}
<div class="summary p-5 px-md-3 pt-1" style="padding-top: 0px !important;">
  <a id="backgrants" class="font-caption" href="/grants">
    <i class="fas fa-chevron-left mr-1"></i>
    Back to Grants
  </a>
  <!-- GRANT LOGO -->
  <div class="grant-logo pb-2" style="padding-top: 20px !important;">
    {% if is_team_member %}
      <a id="change-logo" data-toggle="modal" data-target="#changeLogo">
        <i class="far fa-image" data-toggle="tooltip" data-placement="right" title="Change Grant Profile Photo"></i>
        <img src="{% if grant.logo and grant.logo.url %}{{ grant.logo.url }}{% else %}{% with grant_logo='v2/images/grants/logos/' id=grant.id|modulo:3 %} {% static grant_logo|addstr:id|add:'.png' %} {% endwith %} {% endif %}" style="{{grant.image_css}}">
      </a>

      <div class="modal fade" id="changeLogo" tabindex="-1" role="dialog" aria-labelledby="changeLogoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="modal-body">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <h6 class="modal-title text-center" id="changeLogoLabel">Change Grant Logo</h6>
                <div class="form__drop" id="js-drop">
                  <input id="img-project" type="file" name="input_image" accept="image/*">
                  <span>{% trans "Drag & Drop or Browse" %}</span>
                  <img id="preview"/>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="button button--warning button__small" data-dismiss="modal">Cancel</button>
                <button id="saveLogo" type="submit" class="button button--primary button__small">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>

    {% else %}

      <img src="{% if grant.logo and grant.logo.url %}{{ grant.logo.url }}{% else %}{% with grant_logo='v2/images/grants/logos/' id=grant.id|modulo:3 %} {% static grant_logo|addstr:id|add:'.png' %} {% endwith %} {% endif %}" style="{{grant.image_css}}">

    {% endif %}
  </div>

  <div>
    <h1 class="font-title-xl my-4 font-weight-bold">
      {% if is_team_member %}
        <textarea id="form--input__title" class="p-0 m-0 inline-edit font-body" maxlength="150" disabled>{{ grant.title }}</textarea>
      {% else %}
        {{ grant.title }}
      {% endif %}
    </h1>

     <!-- SUMMARY INFO -->
    <div class="summary-info mb-4 pb-1">

      {% if grant.hidden and not grant.link_to_new_grant %}
        <div class="mb-2 font-smaller-2">
          <i style="width: 14px; top:0.6rem" class="mb-2 mb-md-0 fas fa-eye-slash mr-2 text-center position-relative"></i>
          <p class="d-md-inline">
            <span>This grant is hidden from the main grant explorer.</span> <br>
          </p>
        </div>
      {% endif %}


      <div class="font-body mb-2">
        {% if is_team_member %}
          <textarea id="form--input__reference-url" class="p-0 m-0 inline-edit" disabled>{{ grant.reference_url }}</textarea>
        {% else %}
          <i style="width: 14px;" class="fab fa-github mr-2 text-center"></i>
          <a href="{{ grant.reference_url }}" target="_blank" data-toggle="tooltip" data-html="true" data-placement="top" title="Project URL">
            {{ grant.reference_url }}
          </a>
        {% endif %}
      </div>

      <div class="mb-2">
        <i style="width: 14px;" class="fab fa-ethereum mr-2 text-center"></i>
        <a id="wallet-address" class="wallet-address"
          target="_blank" data-toggle="tooltip" data-placement="top" title="Recipient Funding Address">
          {{ grant.admin_address }}
        </a>
      </div>

      {% if is_unsubscribed_from_updates_from_this_grant %}
        <div class="font-body mb-2">
          <i style="width: 14px;" class="fas fa-comment-slash mr-2 text-center"></i>
            You are unsubscribed from updates for this grant.
          </p>
        </div>
      {% endif %}

      {% if grant.link_to_new_grant %}
        <div class="font-body mb-2">
          <i style="width: 14px;" class="fas fa-times mr-2 text-center"></i>
          <p class="d-inline-block mb-0" data-toggle="tooltip" data-placement="top" title="The grant owner has migrated to a new grant. Click below to visit new grant and fund">
            Not accepting contributions as a new grant was created to replace this one by the ownerâ€©
          </p>
        </div>
      {% elif grant.token_symbol %}
        <div class="font-body mb-2">
          <i style="width: 14px;" class="fas fa-coins mr-2 text-center"></i>
          <p class="d-inline-block mb-0" data-toggle="tooltip" data-placement="top" title="ERC20 Token">
            Grant accepts {{ grant.token_symbol }}
          </p>
        </div>
      {% endif %}

      {% if user_non_errored_subscription %}
        <div class="font-body mb-2">
          <i style="width: 14px;" class="fas fa-info-circle mr-2 text-center"></i>
          <p class="mb-0 d-inline-block" data-toggle="tooltip" data-placement="top" title="Your Current Active Subscription">
            You are contributing
            {{ user_non_errored_subscription.amount_per_period|floatformat:2|intcomma }}
            {{ user_non_errored_subscription.token_symbol }} every {{ user_non_errored_subscription.frequency }} {{ user_non_errored_subscription.frequency_unit }}
          </p>
        </div>
      {% endif %}

    </div>

    {% if grant_is_inactive %}
      <button type="button" class="button button--primary shadow-none font-weight-bold button--full py-3" disabled>
        {% trans "Grant Has Ended" %}
      </button>

    {% elif not is_team_member %}

      {% if user_non_errored_subscription %}
        <a href="{% url 'grants:subscription_cancel' grant.id grant.slug user_subscription.id %}">
          <button class="button button--primary button--warning button--full shadow-none font-weight-bold py-3">{% trans "Cancel Your Funding" %}</button>
        </a>
      {% elif grant.link_to_new_grant %}
        <a href="{{ grant.link_to_new_grant.url }}">
          <button class="button button--primary shadow-none font-weight-bold button--full py-3">
            Visit the active grant to fund
          </button>
        </a>
      {% else %}
        <form id="js-addToCart-form">
          <input type="hidden" id="grant_id" name="grant_id" value="{{ grant.id }}">
          <input type="hidden" id="grant_slug" name="grant_slug" value="{{ grant.slug }}">
          <input type="hidden" id="grant_title" name="grant_title" value="{{ grant.title }}">
          <input type="hidden" id="grant_contract_version" name="grant_contract_version" value="{{ grant.contract_version }}">
          <input type="hidden" id="grant_contract_address" name="grant_contract_address" value="{{ grant.contract_address }}">
          <input type="hidden" id="grant_token_symbol" name="grant_token_symbol" value="{{ grant.grant.token_symbol }}">
          <input type="hidden" id="grant_admin_address" name="grant_admin_address" value="{{ grant.admin_address }}">
          <input type="hidden" id="grant_logo" name="grant_logo" value="{% if grant.logo and grant.logo.url %}{{ grant.logo.url }}{% else %}{% with grant_logo='v2/images/grants/logos/' id=grant.id|modulo:3 %} {% static grant_logo|addstr:id|add:'.png' %} {% endwith %} {% endif %}">
          <input type="hidden" id="grant_image_css" name="grant_image_css" value="{{ grant.image_css }}">
          <button class="btn btn-gc-blue button--full shadow-none font-weight-bold py-3" id='js-addToCart-button'>
            Add To Cart
          </button>
        </form>
      {% endif %}

    {% endif %}

    {% if not is_team_member %}
    <div class="mt-2 pt-2 float-right mb-1">
      {% if grant.negative_voting_enabled %}
        <a id="negative_fund" href="{% url 'grants:fund' grant.id grant.slug %}?direction=-">Negative Fund <i class="fas fa-user-minus"></i></a>
      {% endif %} 
      <a  id="flag" href="#" data-href="/grants/flag/{{grant.id}}">Flag <i class="far fa-flag"></i></a>
    </div>
    {% endif %}
    <br style="clear:both;">


    <div class="mt-2 pt-2">
      <!-- FUNDING AMOUNT-->

      <div class="row progress-container  {% if clr_active %} mb-2 {% endif %} {% if not is_team_member %} mt-4 {% endif %}">
        <div class="col-6 text-center text-xl-left offset-xl-0 col-xl-6 mb-xl-0 ">
          {% if clr_active or show_clr_card %}
            {% include 'grants/card/clr_match.html' %}
          {% else %}
            <p class="sub-title font-weight-semibold font-caption mb-1 pt-1">MONTHLY RECURRING</p>
            <p class="font-title mb-0 font-weight-bold">
              {{ grant.monthly_amount_subscribed|floatformat:0|intcomma }} DAI
            </p>
          {% endif %}
        </div>

        <div class="col-6 text-center text-xl-left offset-xl-0 col-xl-6">
          <p class="sub-title mb-1 font-weight-semibold font-caption mb-1 pt-1">
          {% if is_round_5_5 %}
          ROUND 5.5
          {% else %}
          ROUND 5
          {% endif %}</p>
          <p class="font-subtitle mb-0">
            <span class="font-weight-bold">
              {{grant.amount_received_in_round|floatformat:0|intcomma}} DAI
            </span>
            <BR>
            {{grant.positive_round_contributor_count}} contributors 
            {% if grant.negative_round_contributor_count %}
            <BR>
            {{grant.negative_round_contributor_count}}
            negative contributors 
            {% endif %}
          </p>

        </div>

      </div>

      {% if clr_active or show_clr_card %}
        {% include 'grants/card/clr_estimate.html' %}
      {% endif %}
    </div>


    {% if not is_team_member or grant_is_inactive %}
      {% if grant.categories and grant.categories.all %}
        <div class="mb-2 mt-3 font-body">
          <p class="sub-title mb-1">{% trans "CATEGORIES" %}</p>
          {% for category in grant.categories.all %}
            <span class="btn btn-outline-gc-green py-1 font-weight-bold font-smaller-4">{{ category.category|title }}</span>
          {% endfor %}
        </div>
      {% endif %}
    {% else %}
      <p class="hidden" id="grant-type">{{ grant.grant_type }}</p>

      <div id="edit-grant-category" class="mt-4 mb-2 font-body grant-item-multiselect">
        <p class="sub-title mb-1">{% trans "CATEGORIES" %}</p>
        <div class="form__select2">
          <select id="grant-categories" class="form__input" name="grant-categories" multiple="multiple" disabled>
            {% for category in grant.categories.all %}
            <option value="{{ category.id }}" selected="selected">{{ category.category|title }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    {% endif %}

    <div class="grant-item__member grant-item-multiselect my-4 font-body">
      <p class="sub-title {% if is_team_member %} mb-0 {% else %} mb-3 {% endif %}">
        TEAM
      </p>
      {% if is_team_member and not grant_is_inactive %}
        <div>
          <div class="form__select2">
            <select id="grant-members" class="form__input" name="grant-members" name="members" multiple="multiple" disabled>
              {% for team_member in grant.team_members.all %}
                <option selected="selected"  value="{{ team_member.id }}">{{ team_member }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      {% else %}
        {% if grant.team_members %}
          <div class="grant-item__members d-flex flex-wrap">
            {% for team_member in grant.team_members.all %}
              <a class="grant-item__member-handle mb-3" href="{% url 'profile' team_member %}">
                <div class="grant-item__member grant-item-multiselect mr-5">
                  <div class="mr-2 d-inline-block">
                    <img src="/dynamic/avatar/{{ team_member.handle }}">
                  </div>
                  <div class="mt-1 d-inline-block">
                    <span class="grant-profile font-weight-semibold">{{ team_member }}</span>
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
    </div>

    {% if is_team_member and not grant_is_inactive %}
      <div class="mt-4">
        <button id="edit-details" class="button btn-gc-blue button--full shadow-none font-weight-bold py-3">
          <i class="fas fa-edit mr-2"></i> {% trans "Edit Info" %}
        </button>
      </div>

      <div class="row mx-0">
        <div class="col-12 col-lg-6 px-0 pr-lg-1 mb-2">
          <button id="save-details" class="button btn-gc-blue button--full hidden shadow-none font-weight-bold py-3">
            <i class="fas fa-save mr-2"></i> {% trans "Save Info" %}
          </button>
        </div>
        <div class="col-12 col-lg-6 px-0 pl-lg-1">
          <button id="cancel-details" class="button button--warning button--full hidden shadow-none font-weight-bold py-3">
            <i class="fas fa-times mr-2"></i> {% trans "Cancel Edit" %}
          </button>
        </div>
      </div>

    {% endif %}

    {% if is_admin and not grant_is_inactive %}
      {% csrf_token %}
      <div id="js-cancel_grant" class="mt-3">
        <input type="hidden" id="contract_address" name="contract_address" value="{{ grant.contract_address }}">
        <input type="hidden" id="contract_version" name="contract_version" value="{{ grant.contract_version }}">
        <input type="hidden" id="grant_cancel_tx_id" name="grant_cancel_tx_id" value="">
        <div id="cancel_grant_tooltip" data-toggle="tooltip" data-placement="bottom">
          <button type="button" data-toggle="modal" data-target="#cancelModal" id="cancel_grant"
            class="button button--primary button--full button--warning shadow-none font-weight-bold py-3">
            {% trans "Cancel this Grant" %}
          </button>
        </div>

        <div id="cancelModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="cancelGrantModal" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content px-4 px-lg-5">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body row">
                <div class="col-12 pt-2 pb-2 text-center">
                  <h2 class="font-title">{% trans "Are you sure you want to cancel this grant?" %}</h2>
                </div>
                <div class="col-12 text-center">
                  <img src="{% static "v2/images/grants/cancel-grants-icon.png" %}" />
                </div>
                <div class="col-12 pt-2 pb-2 font-body">
                  <p>{% trans "By clicking Cancel, you will be cancelling this grant from Gitcoin." %}</p>
                  <ul><li>{% trans "Your grant will stay in Gitcoin, but " %}<b>{% trans "marked as inactive." %}</b></li>
                  <li>{% trans "Funds received till now " %}<b>{% trans "will not be refunded " %}</b>{% trans "to the contributors." %}</li>
                  <li>{% trans "Once cancelled, it is " %}<b>{% trans "not possible to restart the grant, " %}</b>{% trans "as the smart contract will be destroyed." %}</li></ul>
                  <p>{% trans "To relaunch the grant, you need to create a new grant." %}</p>
                </div>
                <div class="col-12 mt-4 mb-2 text-center text-md-right font-caption">
                  <a data-dismiss="modal" aria-label="Close dialog" class="button button--primary-o mr-3 shadow-none font-weight-bold py-3">
                    {% trans "No, I don\'t want to cancel" %}
                  </a>
                  <button class="modal-cancel-grants button button--warning shadow-none font-weight-bold py-3">
                    {% trans "Cancel this Grant" %}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="font-body grant-item__owner my-4">
        <div class="mb-3">
          <p class="sub-title" data-toggle="tooltip" data-placement="bottom">Grant Owner</p>
          <div class="mr-2 d-inline-block">
            <img src="{{ grant.admin_profile.avatar_url }}">
          </div>
          <div class="mt-1 d-inline-block">
            <span id="grant-admin" class="font-weight-semibold ">{{ grant.admin_profile.handle|default:'anonymous' }}</span>
          </div>
        </div>
        <div>
          <p class="sub-title mb-0" data-toggle="tooltip" data-placement="bottom" title="Address used to create this grant.">Contract Owner Address</p>
          <p id="contract_owner_address" class="p-0 m-0 font-body">{{ grant.contract_owner_address }}</p>
        </div>
      </div>

    {% endif %}

    <span id="grant_contract_owner_address" class="hidden">{{ grant.contract_owner_address }}</span>

  </div>
</div>
