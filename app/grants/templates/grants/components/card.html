  {% comment %}
  Copyright (C) 2020 Gitcoin Core

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published
  by the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program. If not, see <http://www.gnu.org/licenses/>.
{% endcomment %}
{% load i18n static humanize grants_extra %}
<grant-card inline-template :grant="grant" :cred="credentials" :view="view" :short="shortView"
            :contributions='contributions' :show_contributions="show_contributions" :collection="activeCollection"
            :has_collections="collections.length"
            v-on:collection:remove='removeCollection'>
  <template>
    <div v-if="view == 'list'">
      <div class="grant-item grant-item--list flex-md-row flex-column" >
        <div class="grant-item__img col-md-1 d-md-block d-none my-auto">
          <img :src="grant.logo_url" />
        </div>
        <div :class="`grant-item__content ${ collection && isCurator ? 'col-md-7' : 'col-md-8'} px-3`">
          <h2 class="grant-item__title font-subheader">
            <a :href="grant.details_url">[[ grant.title | truncate(60) ]]</a>
            <button v-if="grant.verified" class="btn btn-sm animate-verify p-0" data-container="body" data-toggle="popover" data-html="true" data-placement="bottom" data-trigger="click" data-content='
             <p class="h6 my-2 text-left">Verified Ownership <img width="18" src="{% static "v2/images/badge-verify.svg" %}"></p>
             <p>Grant owner has verified ownership of their twitter account.</p>
             <a href="#">Learn more.</p>'
            ><img width="13" style="position: relative; top:-1px;" src="{% static 'v2/images/badge-verify.svg' %}" alt="">
            </button>
          </h2>


          <div>
            <p class="text-muted font-smaller-5 mb-0" style="height:2rem;"  data-toggle="tooltip" data-placement="top" title="The last time the grant admin updated the grant." >
              <i style="width: 14px;" class="fas fa-clock mt-2 mb-0 text-center"></i>
              Last Update: [[ grant.last_update ?  grant.last_update_natural : `Long Ago` ]]
              <template v-if="cred.is_staff">
                <span class="ml-3" >
                  <i class="fa fa-lock" aria-hidden="true"></i> SybilScore ™️: [[ grant.sybil_score ]]
                  <span class="mx-2">|</span> RiskScore ™️: [[ grant.weighted_risk_score ]]
                </span>
              </template>
            </p>
            <div class="grant-item__owner">
              <div class="d-flex">
                <a :href="grant.admin_profile.url"  :data-usercard="grant.admin_profile.handle" target="_blank" rel="noopener noreferrer">
                  <div class="d-flex align-center">
                    <div class="grant-item__owner-image ml-2 position-relative" style="top: -4px;">
                      <img :src="grant.admin_profile.avatar_url || 'https://c.gitcoin.co/avatars/57e79c0ae763bb27095f6b265a1a8bf3/thelostone-mc.svg'">
                    </div>
                    <div class="grant-item__owner-handle font-smaller-3">
                      <span class="ml-2">
                        [[ grant.admin_profile.handle || 'anonymous' ]]
                      </span>
                    </div>
                  </div>
                </a>
              </div>
              <div class="d-flex match ml-3">
                <div class="match__round--inline mr-3">
                  <template v-if="grant.clr_round_num">
                    <span class="font-subheader font-weight-bold amount pt-1 mb-2">
                      [[ get_clr_prediction(0, 1) || 0  | round | formatNumber ]]
                      USD
                    </span>
                    <span class="amount mb-2 font-smaller-3">
                      CLR Match
                    </span>
                  </template>
                  <template v-else>
                  </template>
                </div>
                <div v-if="grant.clr_round_num">
                  <span class="font-subheader font-weight-bold amount pt-1 mb-2">
                    [[ grant.amount_received_in_round || 0 | round | formatNumber ]]
                    USD
                  </span>
                  <span class="amount mb-2 font-smaller-3">
                    raised from
                  </span>
                  <span class="amount mb-2 font-smaller-3 font-weight-semibold">
                   [[ grant.positive_round_contributor_count ]] contributors
                  </span>
                </div>
              </div>
              <template v-if="isUserLogged">
                <button @click="toggleFollowingGrant(grant.id, $event)" :class="`ml-3 text-decoration-none btn btn-link star-action m-0 p-0 font-smaller-3 gc-text-blue ${!grant.favorite ? 'text-muted' : ''}`" :data-grant="grant.id">
                  <i :class="`${!grant.favorite ? 'far' : 'fa' } fa-star`" ></i>
                  <span class="ml-1 font-body">[[ !grant.favorite ? 'Follow' : 'Following' ]]</span>
                </button>
                <b-dropdown size="sm" variant="link" toggle-class="text-decoration-none text-muted" id="dropdown-1" text="Add to Collection" class="m-md-2" menu-class="shadow-sm" v-if="has_collections">
                  <template v-slot:button-content>
                    <span class="text-muted"><i class="fas fa-th-large mr-1"></i> Add to Collection</span>
                  </template>
                  <b-dropdown-item @click.prevent="addToCollection({grant, collection})" v-for="collection in collections" :key="collection.id">[[collection.title]]</b-dropdown-item>
                </b-dropdown>
              </template>
            </div>
          </div>
        </div>

        <div :class="`${ collection && isCurator ? 'col-md-4' : 'col-md-3' }`" class="col-sm-12 py-4 pr-md-5 pl-md-0 grant-action mx-1">
          <b-button @click="quickView($event)" size="sm" variant="outline-primary" class="font-weight-semibold font-caption btn-block">
            <i class="far fa-fw fa-eye"></i>
          </b-button>
          <button @click.prevent="addToCart(grant)" :class="{'btn-lg': collection && isCurator}" class="btn btn-primary btn-block font-body font-weight-semibold">
            + Add to Cart
          </button>
          <button @click.prevent="$emit('collection:remove', {collection: collection, grant: grant})"  class="btn btn-block btn-outline-danger font-body font-weight-semibold" v-if="isCurator">
            - Remove from collection
          </button>
        </div>
      </div>
      <div style="background-color: #FAFAFA">
        <div class="clr col-12 mb-3" v-if="show_contributions">
          <div :class="`match__round pb-1 pt-2 ${ (index + 1) % 2 === 0  ? 'no-bg' : ''}`" v-for="(contribution, index) in getContributions(grant.id)">
            <p class="col-12 amount mb-2 font-caption font-weight-semibold"> [[ index + 1 ]]. Contributed
              <span class="font-weight-bold">[[ contribution.amount_per_period ]] [[ contribution.token_symbol ]]</span> at [[ contribution.created_on ]].
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="grant-item" v-else>
      <div class="grant-item__img">
        <img :src="grant.logo_url">
      </div>
      <div class="grant-item__content px-3">
        <h2 class="font-subheader">
          <a :href="grant.details_url" target="_blank" class="gc-font-base h5 text-black">[[ grant.title | truncate(60) ]]</a>
        </h2>
        <span class="">by</span>
        <a :href="grant.admin_profile.url" :data-usercard="grant.admin_profile.handle" target="_blank" rel="noopener noreferrer">
          [[ grant.admin_profile.handle]]
        </a>
        <button v-if="grant.verified" class="btn align-baseline p-0" id="tooltip-verify">
          <b-tooltip target="tooltip-verify" triggers="hover click" variant="light" placement="bottom">
            <p class="h6 my-2 text-left">Verified Ownership <img width="18" src="{% static "v2/images/badge-verify.svg" %}"></p>
            <p class="text-left">Grant owner has verified ownership of their twitter account.</p>
          </b-tooltip>
          <img width="13" src="{% static 'v2/images/badge-verify.svg' %}" alt="">
        </button>
        <p class="grant-item__pitch font-caption my-2">[[ grant.description | truncate(138) ]]</p>
        <p class="grant-item__pitch font-caption mb-0" style="height:2rem;"  data-toggle="tooltip" data-placement="top" title="The last time the grant admin updated the grant." >
          <span class="font-smaller-5">
            <i class="fas fa-fw fa-clock mt-2"></i>
            Last Update: [[ grant.last_update ?  grant.last_update_natural : `Long Ago` ]]
          </span>
        </p>
        <hr class="my-2">
        <template v-if="cred.is_staff">
          <p class="font-caption font-weight-semibold mb-0">
            <i class="fa fa-lock mr-2" aria-hidden="true"></i>
            SybilScore ™️: [[ grant.sybil_score ]]
            <span class="mx-2">|</span>
            RiskScore ™️: [[ grant.weighted_risk_score ]]
          </p>
        </template>

        <!-- <div class="grant-item__owner my-3 justify-content-between">
          <div>
            <a :href="grant.admin_profile.url" :data-usercard="grant.admin_profile.handle" target="_blank" rel="noopener noreferrer">
              <div class="grant-item__owner">
                <span class="grant-item__owner-handle font-body">By</span>
                <div v-if="grant.admin_profile.avatar_url" class="grant-item__owner-image mx-2">
                  <img :src="grant.admin_profile.avatar_url">
                </div>
                <div class="grant-item__owner-handle font-smaller-2">
                  [[ grant.admin_profile.handle]]
                </div>
              </div>
            </a>
          </div>
          <template v-if="isUserLogged">
            <button @click="toggleFollowingGrant(grant.id, $event)" :class="`text-decoration-none btn btn-link star-action m-0 p-0 mr-4 gc-text-blue ${!grant.favorite ? 'text-muted' : ''}`" :data-grant="grant.id">
              <i :class="`${!grant.favorite ? 'far' : 'fa' } fa-star`" ></i>
              <span class="ml-1 font-body">[[ !grant.favorite ? 'Follow' : 'Following' ]]</span>
            </button>
          </template>
        </div> -->
      </div>
      <div class="grant-item__footer mt-2">
          <div class="mb-3">
            <div class="col mb-1">
              <img class="float-right" height="20" src="{% static "v2/images/chains/ethereum.svg" %}" v-if="grant.tenants.indexOf('ETH') > -1">
              <img class="float-right" height="20" src="{% static "v2/images/chains/zcash.svg" %}" v-if="grant.tenants.indexOf('ZCASH') > -1">
              <img class="float-right" height="20" src="{% static "v2/images/chains/zilliqa.svg" %}" v-if="grant.tenants.indexOf('ZIL') > -1">
              <img class="float-right" height="20" src="{% static "v2/images/chains/celo.svg" %}" v-if="grant.tenants.indexOf('CELO') > -1">
              <p class="mb-0" v-if="grant.clr_round_num && grant.is_clr_eligible">
                [[grant.clr_round_num]]
              </p>

            </div>
            <div class="col" v-if="grant.clr_round_num">
              <p class="text-black h4 gc-font-base">
                $[[ grant.amount_received_in_round || 0 | round | formatNumber ]]
              </p>
              <p class="">
                raised from [[ grant.positive_round_contributor_count ]] contributors
              </p>
            </div>
            <div class="col-6" v-if="grant.clr_round_num">

              <template v-if="grant.is_clr_eligible">
                <p class="font-body">
                  Est. Matching <span class="text-success">$[[ get_clr_prediction(0, 1) || 0  | round | formatNumber ]]</span>
                </p>
              </template>
              <template v-else>
                <p class="">
                  [[ grant.amount_received || 0 | round | formatNumber ]]
                  USD
                </p>
                <p class="">All Time Funding</p>
              </template>
            </div>
          </div>

          {% comment %}
          <div class="col-12 pb-3" v-if="grant.is_clr_eligible && grant.is_clr_active && grant.clr_round_num">
            {% include 'grants/components/clr_estimate.html' %}
          </div>
          {% endcomment %}

          <div class="d-flex mx-3 justify-content-between" v-if="isUserLogged && has_collections">
            <b-dropdown size="sm" variant="link" toggle-class="text-decoration-none text-muted" id="dropdown-1" text="Add to Collection" class="mr-2" menu-class="shadow-sm" v-if="has_collections">
              <template v-slot:button-content>
                <span class="text-muted"><i class="fas fa-th-large mr-1"></i> Add to Collection</span>
              </template>
              <b-dropdown-item @click.prevent="addToCollection({grant, collection})" v-for="collection in collections" :key="collection.id">[[collection.title]]</b-dropdown-item>
            </b-dropdown>
          </div>

          <div class="mx-3 mt-1 pb-4">
            <div class="d-flex justify-content-between pb-1">
              <b-button @click="quickView($event)" size="sm" variant="outline-primary" class="mr-1 font-body">
                <i class="fas fa-fw fa-eye"></i>
              </b-button>
              <button @click.prevent="removeFromCart(grant)" class="btn btn-outline-danger ml-1 font-body" style="flex: 1 1 0px;" v-if="grant.isInCart">
                - Remove from Cart
              </button>
              <button @click.prevent="addToCart(grant)" class="btn btn-primary ml-1 font-body" style="flex: 1 1 0px;" v-else>
                + Add to Cart
              </button>
            </div>
            <button @click.prevent="$emit('collection:remove', {collection: collection, grant: grant})" class="btn btn-block btn-outline-danger font-body mt-1 mr-1" v-if="collection && isCurator">
            - Remove from collection
            </button>
          </div>

          <div class="clr mb-3" v-if="show_contributions">
            <div :class="`match__round pb-1 pt-2 ${ (index + 1) % 2 === 0  ? 'no-bg' : ''}`" v-for="(contribution, index) in getContributions(grant.id)">
              <p class="col-12 amount mb-2 font-caption font-weight-semibold"> [[ index + 1 ]]. Contributed
                <span class="font-weight-bold">[[ contribution.amount_per_period ]] [[ contribution.token_symbol ]]</span> at [[ contribution.created_on ]].
              </p>
            </div>
          </div>

      </div>
    </div>
  </template>
</grant-card>
