#! /bin/bash
set -eou pipefail

# start ganache and send to background
node_modules/.bin/ganache-cli -m "${SECRET_WORDS}" -h 0.0.0.0 &

# build assets
mkdir -p app/assets/{static,media}
export STATICFILES_DIRS="${TRAVIS_BUILD_DIR}/app/assets/"
python3 app/manage.py bundle
yarn run build

python3 app/manage.py collectstatic --noinput --disable-collectfast

# set up database
python3 app/manage.py migrate
python3 app/manage.py loaddata "${TRAVIS_BUILD_DIR}/app/app/fixtures/users.json"

# run app server
python3 app/manage.py runserver 0.0.0.0:8000 &

# create superuser based on credentials in the readme
export DJANGO_SUPERUSER_PASSWORD=gitcoinco
python3 app/manage.py createsuperuser --noinput --username root

# run cypress tests
export NETWORK_NAME=localhost
export CYPRESS_REMOTE_DEBUGGING_PORT=9222
export VERBOSE=1
node_modules/.bin/cypress install
node_modules/.bin/wait-on http://0.0.0.0:8000
node_modules/.bin/cypress run \
  --browser chrome \
  --headed \
  --record \
  --key 23c824d9-b9eb-4aea-88fd-d0bb06a9eb51
